vscodeではフォルダではなく、MQTT.code-workspaceを使用してワークスペースとして開くとコンテナ内のirisに疎通する。

Windows10 + VM(Ubuntu20.04)で動かす方法

$ ./setup.sh
$ docker-compose up -d
起動待ち
$ docker-compose exec iris iris session iris -U %SYS "##class(App.Installer).InitializeDocker()"
You have successfully initiated the MQTT exercise
Please take note of your topic top-level string: /Student_3987/acmeHospital/EKG/#
press enter to continue
$


注意)
ブローカをネット上のものから、自前(コンテナ)に変更
mqtt.eclipseprojects.ioをmqttbrokerに変更。これにより、下記Webアプリは動作しなくなった。
Webアプリはwebsocket使用しているが、配布バイナリはWEBSOCKETSがDISABLEされているため。

UIを起動してアイテムを追加、値を変更を実施。
http://irishost/app.html

代わりに、下記のコマンドラインを実行すること。
mosquitto clientで監視する方法。
$ docker-compose exec iris bash
# mosquitto_pub -h "mqttbroker" -p 1883 -t /Student_6084/acmeHospital/EKG -m "90"
# mosquitto_sub -v -h "mqttbroker" -p 1883 -t /Student_6084/acmeHospital/EKG/#

バイナリファイルを送る
# mosquitto_pub -h "mqttbroker" -p 1883 -t /Student_6084/acmeHospital/EKG -f /home/irisowner/share/data1.data



補足
MQTTクライアント機能を直接使用する方法
$ docker-compose exec iris iris session iris
USER>set tSC=##class(%Net.MQTT.Client).%New("tcp://mqttbroker:1883")
USER>set tSC=m.Connect()
USER>set tSC=m.Subscribe("/Student_6832/acmeHospital/EKG/#")
USER>set tSC=m.Receive(.topic,.message)
USER>wriste
m=<OBJECT REFERENCE>[1@%Net.MQTT.Client]
message=184
topic="/Student_6832/acmeHospital/EKG/Patient-0"
USER>h
$


PEXを使わずに.NETを呼び出す方法
USER>w $SYSTEM.external.getRemoteGateway("netgw",55556).new("System.DateTime",0).Now
2021-11-19 03:51:03.4967784

USER>Set gw=$SYSTEM.external.getRemoteGateway("netgw",55556)
USER>do gw.addToPath("/app/MyLibrary.dll")
USER>set proxy = gw.new("dc.MyLibrary")
USER>w proxy.GetNumber()
123

hint
https://github.com/intersystems/Samples-PEX-Course


自前でビルドするには
https://github.com/eclipse/mosquitto
>libwebsockets (libwebsockets-dev) - enable with make WITH_WEBSOCKETS=yes

sudo apt-get install build-essential libwebsockets-dev
make WITH_WEBSOCKETS=yes WITH_DOCS=no WITH_TLS=no WITH_CJSON=no
sudo make WITH_WEBSOCKETS=yes WITH_DOCS=no WITH_TLS=no WITH_CJSON=no install
ls /usr/local/sbin/ -l
total 2072
-rwxr-xr-x 1 root root 2120800 Nov 29 13:47 mosquitto
